---
Keywords: Rust, thread, fork
Copyright: (C) 2023 Ryuichi Ueda
---

# RustでスレッドがMutexのロックをかけた状態でプロセスがフォークしたら？

・・・子のプロセスでロックが外れるのかどうか実験してみました。もう少し詳しく書くと、こういう実験です。

* 実験の内容
    * あるプログラムでサブのスレッドをひとつ作って、ある変数に対してロックをかけっぱなしにする（もとのスレッドは「メインのスレッド」と呼びましょう。）
    * メインのスレッドでフォークをかける
        * このとき、子のプロセスでサブのスレッドは止まる（[参考](https://amzn.to/3NkC0X2)） 
* 疑念: 子のサブのスレッドがロックをかけたまま止まるので、子でロックが外れないのではないか？

## 先に結論

下記の実験の結果を見ると、ロックは外れるみたいです。（コードを解読すれば完璧ですが、それはまだです。）


## 実験

### 使ったコード

こんな感じ。8行目でArc（参照カウンタ）とMutex（排他制御のための型）にくるんだ文字列をひとつ作って、これを

* サブのスレッド
* 親のメインスレッド
* 子のメインスレッド

で読み書きしています。

<script src="https://gist.github.com/ryuichiueda/a05823182d1a0c8f09fb44ceaf3ad8ad.js"></script>



