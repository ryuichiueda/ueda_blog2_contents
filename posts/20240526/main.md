---
Keywords: 自作シェル, 寿司シェル, sush
Copyright: (C) 2024 Ryuichi Ueda
---

# 自作シェルの進捗とBashの細かい話（2024年5月26日）

　前回に引き続き自作シェルの開発が暴走気味なのでドキュメントを残すための記事です。case文のためにBashのグロブの拡張を実装していました。こんな機能、自分では使わないのですが、[bash-completionの巨大スクリプト](https://github.com/scop/bash-completion/blob/main/bash_completion)が使ってるので泣きながら実装していました。

　で、だいたいできました。たぶん連載で扱うのは2年後でしょうか・・・


## 実装したグロブの拡張

　こんなやつです。たぶん最近のBashだとデフォルトで使えます。

```bash

### @()内の|で区切ったひとつのパターンにマッチ ###
$ case 小山田 in @(五反|山|小山)田) echo マッチ ;; *) echo マッチせず ;; esac
マッチ
### @()内の|で区切ったひとつのパターンに0回か1回マッチ ###
$ case 田 in ?(五反|山|小山)田) echo マッチ ;; *) echo マッチせず ;; esac
マッチ
### !()内の|で区切ったひとつのパターンにマッチするとアンマッチ ###
$ case 小山田 in !(五反|山|小山)田) echo マッチ ;; *) echo マッチせず ;; esac
マッチせず
# 注意: これは「山小小小」が!(山)とマッチ（山とアンマッチ）するのでマッチ
$ case 山小小小田 in !(山)田) echo マッチ ;; *) echo マッチせず ;; esac
マッチ
### +()内の|で区切ったひとつのパターンに1つ以上繰り返しでマッチするとマッチ ###
case 上田山田田 in +(山田|上田)田) echo マッチ ;; *) echo マッチせず ;; esac
マッチ
### *()内の|で区切ったひとつのパターンに0つ以上繰り返しでマッチするとマッチ ###
$ case 田 in *(山田|上田)田) echo マッチ ;; *) echo マッチせず ;; esac
マッチ
```

　で、[寿司シェル](https://github.com/shellgei/rusty_bash)のmainブランチにも同じものが実装されています。バグがなければいいなあ・・・（あれば指摘は大歓迎です）。

　マッチングの処理は、 https://github.com/shellgei/rusty_bash/blob/main/src/elements/command/case/tools.rs にありますが、まだ整理していません。

## 今後

　パーサーの側では、`@(  )`などの文字列を引数にしてもエラーがで出ないように、いろいろコードを追加しました。次のようにブレース展開とかもできます。

```bash

🍣 echo @({あいう,えお}|{AB,CDE})
@(あいう|AB) @(あいう|CDE) @(えお|AB) @(えお|CDE)
```

ただ、Bashだとブレース展開後に次のように拡張されたグロブが機能するのですが、

```bash

### Bashの場合 ###
$ echo /@({b,m})*
/bin /boot /media /mnt
```

寿司シェルでは使っているクレートが拡張に対応しておらず、何も起こりません。

```bash

### 寿司シェルの場合 ###
🍣 echo /@({b,m})*
/@(b)* /@(m)*
```

・・・これは、ファイルグロブを実装しろということでしょうか・・・


現場からは以上です。

