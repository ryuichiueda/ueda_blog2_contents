---
Keywords: æ—¥è¨˜, è‡ªä½œã‚·ã‚§ãƒ«
Copyright: (C) 2023 Ryuichi Ueda
---

# æ—¥è¨˜ï¼ˆ2023å¹´11æœˆ11æ—¥ï¼‰

ã€€æŸ»èª­ã°ã£ã‹ã‚Šã§ã€ã‚ã¾ã‚Šã«ã‚‚æŸ»èª­ã—ãŸããªãã¦ã“ã‚Œã‚’è¨˜ã—ã¦ãŠã‚Šã¾ã™ã€‚

## ã‚·ã‚§ãƒ«èŠ¸å‹‰å¼·ä¼š

12æœˆ16æ—¥ã‚„ã‚Šã¾ã™ï¼ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨å¢“ç©´ã‚’é–‹ã‘ã¦å¾…ã£ã¦ã¦ãã ã•ã„ï¼ãŸã¶ã‚“éƒ½å†…æŸæ‰€ã§ã™ã€‚

## Rustã§ã‚¯ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã£ã¦ã‚·ã‚°ãƒŠãƒ«ã‚’éåŒæœŸã§å—ã‘ã‚ˆã†ã¨ã™ã‚‹ã¨ãƒ•ã‚¡ã‚¤ãƒ«è¨˜è¿°å­ã‚’ä½¿ã„ã‚„ãŒã‚‹

ã€€æœ€è¿‘ã®ä¸€ç•ªã®æ‚©ã¿ã§ã€[ctrlc](https://crates.io/crates/ctrlc)ã‚’ä½¿ã£ã¦ã‚‚ã€[signal-hook](https://crates.io/crates/signal-hook)ã‚’ä½¿ã£ã¦ã‚‚ã€éåŒæœŸå‡¦ç†ã§ãƒ‘ã‚¤ãƒ—ã‚„ã‚½ã‚±ãƒƒãƒˆã‚’ä½¿ã£ã¦ã—ã¾ã†ãŸã‚ã€æœ¬æ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãŸã‚ã«é–‹ã‘ã¦ãŠãå¿…è¦ã®ã‚ã‚‹3ç•ªã‚„4ç•ªã®ãƒ•ã‚¡ã‚¤ãƒ«è¨˜è¿°å­ã‚’ä½¿ã£ã¦ã—ã¾ã„ã¾ã™ã€‚[ã‚·ã‚§ãƒ«ã‚’ä½œã£ã¦ã„ã‚‹ã®ã«](/page=sd_rusty_bash)ã€ãã‚“ãªè‹¥ã„ç•ªå·ã®ãƒ•ã‚¡ã‚¤ãƒ«è¨˜è¿°å­ã‚’å‹æ‰‹ã«ä½¿ã£ã¦ã‚‚ã‚‰ã£ã¦ã¯å›°ã‚‹ã‚“ã§ã™ãŒã€ã»ã‹ã«ã‚ˆã„æ–¹æ³•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãŸã¶ã‚“`main`ã«å…¥ã£ã¦ã™ãã«3ã€œ9ã‚’ä½¿ã„æ½°ã—ã¦ã‹ã‚‰ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å‹•ã‹ã—ã¦ã€3ã€œ9ã‚’é–‰ã˜ã‚Œã°ãªã‚“ã¨ã‹ãªã‚Šãã†ã§ã™ãŒã€ãã‚Œã§ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çŸ¥ã‚‰ãªã„ãƒ•ã‚¡ã‚¤ãƒ«è¨˜è¿°å­ãŒ`/proc/$$/fd`ã®ä¸‹ã«è¦‹ãˆãŸã‚‰å«Œãªã‚ã‘ã§ã€ã©ã†ã—ã‚ˆã†ã‹ã¨ã€‚Rustã ã¨ã©ã†ã—ã¦ã‚‚ãã†ã—ãªã„ã¨ã ã‚ãªã‚“ã§ã™ã‹ã­ï¼Ÿ

ã€€ä¸€å¿œã€[ã“ã‚ŒãŒ](https://github.com/shellgei/rusty_bash/blob/sd/202405_async/src/main.rs)é€£è¼‰ã§ä½œã£ã¦ã„ã‚‹ã‚·ã‚§ãƒ«ã‚’`SIGCHLD`ã«éåŒæœŸã§åå¿œã§ãã‚‹ã‚ˆã†ã«ã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¸ã®ãƒªãƒ³ã‚¯ã§ã™ï¼ˆæ­£ç¢ºã«ã¯`main.rs`ã¸ã®ãƒªãƒ³ã‚¯ã§ã€ã“ã“ã«`SIGCHLD`ã‚’å¾…ã£ã¦ã„ã‚‹è¨˜è¿°ãŒã‚ã‚Šã¾ã™ã€‚ï¼‰ã€‚ãªã«ã‹ãƒ”ãƒ³ã¨æ¥ãŸã‚‰ã”ä¸€å ±ã‚’ã€‚

### è¿½è¨˜

ã€€å…ˆäººãŒå…¨ãåŒã˜ã“ã¨ã§æ‚©ã¾ã‚Œã¦ãŠã‚Šã¾ã—ãŸã€‚å¾Œè¿½ã„ã§ä¼¼ãŸã“ã¨ã‚’ã—ã¦ã—ã¾ã£ã¦ãŠã‚Šã„ã¤ã‚‚æç¸®ã—ã¦ãŠã‚Šã¾ã™ã§ã™ã€‚

* reddish-shell v0.11.0-beta4 é–‹ç™ºé€²æ— | ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œã€ã‚³ãƒãƒ³ãƒ‰ç½®æ›ã®å®Ÿè£… | ã¶ã¦ã„ã®ãƒ­ã‚°ã§ã¶ãƒ­ã‚°: https://tech.buty4649.net/entry/2021/11/11/000845

### è¿½è¨˜2

ã€€ä¸Šè¨˜ã®ã€ŒãŸã¶ã‚“`main`ã«å…¥ã£ã¦ã™ãã«3ã€œ9ã‚’ä½¿ã„æ½°ã—ã¦ã‹ã‚‰ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å‹•ã‹ã—ã¦ã€3ã€œ9ã‚’é–‰ã˜ã‚Œã°ãªã‚“ã¨ã‹ãªã‚Šãã†ã§ã™ãŒã€ã€ã‚’ã‚„ã£ã¦ã¿ã¾ã—ãŸã€‚

```rust
44 fn run_childcare(core: &mut ShellCore) { //SIGCHLDã‚’è£œè¶³ã™ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ç«‹ã¡ä¸Šã’ã‚‹é–¢æ•°
45     for fd in 3..10 { // FD3ã€œ9ã‚’ä½¿ã£ã¦å¡ã„ã§ã—ã¾ã†ã€‚
46         unistd::dup2(2, fd).expect("sush(fatal): init error");
47     }
48
49     let jt = Arc::clone(&core.job_table);
50     thread::spawn(move || {
51         let mut signals = Signals::new(vec![SIGCHLD])
52                           .expect("sush(fatal): cannot prepare signal data");
53
54         for fd in 3..10 { // ç„¡é™ãƒ«ãƒ¼ãƒ—ã«å…¥ã‚‹å‰ã«FD3ã€œ9ã‚’é–‹æ”¾
55             unistd::close(fd).expect("sush(fatal): init error");
56         }
57
58         loop {
59             thread::sleep(time::Duration::from_secs(1));
60             for signal in signals.pending() {
61                 check_signal(signal, &jt);
62             }
63         }
64     });
65 }
```


ã€€ã§ãã¾ã—ãŸã€‚`signal-hook`ã®ãƒ•ã‚¡ã‚¤ãƒ«è¨˜è¿°å­ãŒ10ã¨11ã«ãªã£ã¦ã¾ã™ã€‚

```bash
ğŸ£ ls -l /proc/112159/fd
åˆè¨ˆ 0
lrwx------ 1 ueda ueda 64 11æœˆ 11 17:13 0 -> /dev/pts/2
lrwx------ 1 ueda ueda 64 11æœˆ 11 17:13 1 -> /dev/pts/2
lrwx------ 1 ueda ueda 64 11æœˆ 11 17:13 10 -> 'socket:[1070478]'
lrwx------ 1 ueda ueda 64 11æœˆ 11 17:13 11 -> 'socket:[1070479]'
lrwx------ 1 ueda ueda 64 11æœˆ 11 17:13 2 -> /dev/pts/2
lrwx------ 1 ueda ueda 64 11æœˆ 11 17:13 255 -> /dev/pts/2
```

