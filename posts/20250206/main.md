---
Keywords: シェル芸勉強会
Copyright: (C) 2024 Ryuichi Ueda
---

# 自作シェルの端末まわりについてメモ書き


　最近、自作シェルで端末から字を読む際のバグと格闘しているのでメモして頭を整理します。

## 経緯

　こんなかんじ

* 自作シェルに`trap`を実装した
* プロンプトが出ている時に`trap`を受信したいが、文字入力を非同期で待っていないので無理
* [termionの非同期入力](https://docs.rs/termion/latest/termion/struct.AsyncReader.html)を使って文字入力の受付を実装しなおし
* バグ出た


## バグ

* Linuxの場合
    * Vimを立ち上げると画面がバグったり、「指定の位置にカーソルがありません」と出る。（何かキーを押すと直る）
* macOSの場合
    * 何かコマンドを立ち上げると`SIGTTIN`が飛んできてシェルが終わる
    * 端末のサイズを変えるとtermionの`cursor.rs`でpanicが起こる
    * 端末にEnterを入力し続けると`cursor.rs`でpanicが起こる

LinuxのバグとmacOSの`SIGTTIN`については、たぶんコマンドが立ち上がっている間になにか余計な文字がシェル（というよりたぶんtermionのコード）から出てる。

## 対策

　とりあえず非同期入力をやめるのは別として、

* シェルのプログラムのしょっぱなに`SIGTTIN`を無効に
* カーソルの位置をむやみにtermionから取らず、自分で計算する。
* 文字入力の受付開始のときだけ、やむなくtermionからカーソルの位置をとる必要があるので、最初の一文字だけ入力を同期処理にする
