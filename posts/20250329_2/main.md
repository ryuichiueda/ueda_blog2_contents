---
Keywords: 自作シェル,rusty_bash,寿司シェル
Copyright: (C) 2025 Ryuichi Ueda
---

# 自作シェルの進捗（2025年3月29日その2）

　[前の記事](/?post=20250329)の続きです。前の記事のとおり、
Bashの公式リポジトリのテストを使い始めました。しかしこのテスト、
エッジケースが多い上にテストスクリプト自体が
bash-completion並みに変態なので、
それに対応せねばならずいろいろ調べてました。

## Bashではfunctionと書けば`()`が省略できる

　テストスクリプトを自作シェルに読み込ませると
「`function`なんてコマンドねえよ」
（=`function`というキーワードで始まると、
関数の定義部分が認識できない）
というエラーが出たのでおかいしなあと色々調べてたんですが、
テストスクリプトの当該のところを見たら関数の定義に`()`
がついてません。

* [当該部分](https://github.com/ryuichiueda/bash_for_sush_test/blob/80e51650daea4ce8b444b75e0a960dc08e724075/tests/nameref8.sub#L14-L19)
    ```bash
    ### ./tests/nameref8.sub ###
    function f1
    {
    	typeset -n v=$1
    
    
    	v=inside
    }
    ```

どうやら`function`と明示的に書いて関数を定義すると
`()`が要らんようです。確かにシェルの関数の`()`
はなんの意味もない飾りなので合理的ではあるけど、
そんなこと知るか。

　ということで自作シェルも`()`なしで大丈夫なように直しました。

```bash
### alphaブランチ ###
🍣 function oniku { echo 肉 ; } ; oniku
肉
```

そんなこと知るか（重要でないけど2回言う）。


## Bashのglobstarは同じパスを何回も出す

Bashで`shopt -s globstar`を実行すると、
ファイルグロブ（ワイルドカード）で`**`
という表現が使えるようになります。
これはあるディレクトリの階層で`echo ./**`みたいに使うと、
それ以下にあるファイルやディレクトリのパスを
すべて列挙できるという機能です。

で、自作シェルでは辛いので実装を後回しにしてたのですが、
Bashの公式テストに叱られるので実装しました。


ビビってた割には簡単に実装できたのですが、
うまく動いているはずなのになぜかテストが通りません。
で、テストの正解を見たりBashの挙動を調べたりしていたところ、
Bashが同じパスを何回も出力しているのを発見しました。

@@@

そんなこと知るか（3回目）。

テストスクリプトにこう書いてあるので

@@@

kshに互換性を持たせているか、
同じ実装になっているようなのですが、
流石にこれは真似しなくていいだろうということで、
テストの正解の方をuniqしてテストはパスしたということにしました。



## IFSよくわからん

単語の区切り文字を変えるための変数`IFS`への対応が中途半端で、
テストで叱られまくったので自作シェルを改良しました。
ただ、いろいろ挙動が謎なのでコードがスパゲッティーになって頭を抱えてます。
わけのわからん挙動、一例だけ挙げておきます。

@@@

これがBashの挙動だと言われても拒否したいのですが、
テストに通らんのでしぶしぶ合わせました。

もう一点困ってるのは、
端末上のBashの挙動がテストと合わないことです。

@@@

何が原因なのか調査中と言いたいところですが、
他のことを優先すべきということで放置してます。
このテスト、@@@通りのケースから構成されているんですが、
いまのところ@@@がOK、@@@がNGです。

## その他

テストスクリプトで使われていたのでヒアドキュメントを実装しました。
まだちょっと雑です。

また、自作シェルは一部Bashより機能が多いのですが、
それが発動するとテストが通らなくなるので新たに`-b`
（bash compatibility）というオプションをつけました。
本家Bashにも`--compat〇〇`というオプションがあるんですが、
これもおいおい（数年後）サポートしようと思います。


明日は`printf`の実装が雑なのをなんとかして、
`let`を実装する予定です。

現場からは以上です。
